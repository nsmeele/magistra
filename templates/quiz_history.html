{% extends "base.html" %}

{% block title %}Quiz Geschiedenis - Magistra{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Quiz Geschiedenis</h2>
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Terug naar overzicht
    </a>
</div>

{% if incomplete_sessions %}
    <div class="bg-gradient-to-br from-fuchsia-400 to-rose-500 p-8 rounded-lg mb-8">
        <h3 class="text-white mt-0">Onvoltooide Quizzen</h3>
        <p class="text-white mb-6">Je hebt {{ incomplete_sessions|length }} quiz{% if incomplete_sessions|length != 1 %}zes{% endif %} die nog niet af {% if incomplete_sessions|length == 1 %}is{% else %}zijn{% endif %}:</p>

        {% for session in incomplete_sessions %}
            <div class="bg-white p-6 rounded-lg mb-4 border-l-4 border-l-rose-500 hover:shadow-lg">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h4 class="m-0 mb-1">
                            {% if session.quiz_type == 'single' %}
                                {% if session.session_lists %}
                                    {{ session.session_lists[0].list.name }}
                                {% else %}
                                    Enkele Quiz
                                {% endif %}
                            {% else %}
                                Gemengde Quiz
                                {% if session.session_lists %}
                                    ({{ session.session_lists|length }} lijsten)
                                {% endif %}
                            {% endif %}
                        </h4>
                        <p class="text-gray-500 text-sm m-0">Gestart op {{ session.started_at.strftime('%d %b %Y, %H:%M') }}</p>
                    </div>
                    <div class="text-right">
                        <span class="block font-semibold mb-2">{{ session.current_index }}/{{ session.total_questions }}</span>
                        <div class="w-30 h-2 bg-gray-200 rounded overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-fuchsia-400 to-rose-500 transition-[width] duration-300" style="width: {{ (session.current_index / session.total_questions * 100) if session.total_questions > 0 else 0 }}%"></div>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 items-center mb-4">
                    <span class="inline-block px-3 py-1 bg-blue-500 text-white rounded text-sm uppercase">{{ session.direction|upper }}</span>
                    {% if session.quiz_type == 'mixed' and session.session_lists %}
                        <span class="text-gray-500 text-sm">
                            {% for sl in session.session_lists[:3] %}
                                {{ sl.list.name }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                            {% if session.session_lists|length > 3 %}
                                +{{ session.session_lists|length - 3 }} meer
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
                <div class="flex gap-2">
                    <a href="{{ url_for('main.resume_quiz', session_id=session.id) }}" class="btn btn-small btn-primary">
                        <i class="fas fa-play"></i> Hervat Quiz
                    </a>
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}

{% if sessions %}
    <div class="grid grid-cols-[repeat(auto-fit,minmax(200px,1fr))] gap-4 mb-8">
        <div class="bg-white p-6 rounded-lg text-center">
            <h3 class="text-4xl m-0 mb-2 text-blue-500">{{ sessions|length }}</h3>
            <p class="m-0 text-gray-500">Quizzen voltooid</p>
        </div>
        <div class="bg-white p-6 rounded-lg text-center">
            <h3 class="text-4xl m-0 mb-2 text-blue-500">{{ "%.1f"|format((sessions|map(attribute='score_percentage')|sum / sessions|length) if sessions else 0) }}%</h3>
            <p class="m-0 text-gray-500">Gemiddelde score</p>
        </div>
    </div>

    {% if sessions|length > 3 %}
    <div class="bg-white p-6 rounded-lg mb-8">
        <h3 class="mt-0">Score Verloop</h3>
        <canvas id="scoreTrendChart" width="400" height="150"></canvas>
    </div>
    {% endif %}

    <div>
        <h3 class="mb-4">Alle Quizzen</h3>
        {% for session in sessions %}
            <div class="bg-white p-6 rounded-lg mb-4 border-l-4 border-l-gray-200 hover:shadow-lg">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h4 class="m-0 mb-1">
                            {% if session.quiz_type == 'single' %}
                                {% if session.session_lists %}
                                    {{ session.session_lists[0].list.name }}
                                {% else %}
                                    Enkele Quiz
                                {% endif %}
                            {% else %}
                                Gemengde Quiz
                                {% if session.session_lists %}
                                    ({{ session.session_lists|length }} lijsten)
                                {% endif %}
                            {% endif %}
                        </h4>
                        <p class="text-gray-500 text-sm m-0">{{ session.completed_at.strftime('%d %b %Y, %H:%M') }}</p>
                    </div>
                    <div class="text-right">
                        <span class="block text-2xl font-bold {% if session.score_percentage >= 80 %}text-green-500{% elif session.score_percentage >= 60 %}text-orange-500{% else %}text-red-500{% endif %}">{{ session.correct_answers }}/{{ session.total_questions }}</span>
                        <span class="block text-sm text-gray-500">{{ session.score_percentage }}%</span>
                    </div>
                </div>
                <div class="flex gap-4 items-center mb-4">
                    <span class="inline-block px-3 py-1 bg-blue-500 text-white rounded text-sm uppercase">{{ session.direction|upper }}</span>
                    {% if session.quiz_type == 'mixed' and session.session_lists %}
                        <span class="text-gray-500 text-sm">
                            {% for sl in session.session_lists[:3] %}
                                {{ sl.list.name }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                            {% if session.session_lists|length > 3 %}
                                +{{ session.session_lists|length - 3 }} meer
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
                <div class="flex gap-2">
                    <a href="{{ url_for('main.quiz_history_detail', session_id=session.id) }}" class="btn btn-small btn-primary">
                        <i class="fas fa-eye"></i> Bekijk Details
                    </a>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <p class="empty-state">Je hebt nog geen quizzen voltooid. <a href="{{ url_for('main.index') }}">Start een quiz!</a></p>
{% endif %}

{% if sessions|length > 3 %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
const ctx = document.getElementById('scoreTrendChart').getContext('2d');
const sessions = [{% for s in sessions %}{{ s.to_dict()|tojson }}{% if not loop.last %},{% endif %}{% endfor %}];

// Reverse to show oldest first in chart
const reversedSessions = sessions.slice().reverse();

const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: reversedSessions.map((s, i) => i + 1),
        datasets: [{
            label: 'Score %',
            data: reversedSessions.map(s => s.score_percentage),
            borderColor: '#4CAF50',
            backgroundColor: 'rgba(76, 175, 80, 0.1)',
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Quiz Nummer'
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.parsed.y.toFixed(1) + '%';
                    }
                }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}