{% extends "base.html" %}

{% block title %}Quiz Geschiedenis - Magistra{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Quiz Geschiedenis</h2>
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Terug naar overzicht
    </a>
</div>

{% if incomplete_sessions %}
    <div class="incomplete-quizzes">
        <h3>Onvoltooide Quizzen</h3>
        <p class="incomplete-notice">Je hebt {{ incomplete_sessions|length }} quiz{% if incomplete_sessions|length != 1 %}zes{% endif %} die nog niet af {% if incomplete_sessions|length == 1 %}is{% else %}zijn{% endif %}:</p>

        {% for session in incomplete_sessions %}
            <div class="session-card incomplete">
                <div class="session-header">
                    <div>
                        <h4>
                            {% if session.quiz_type == 'single' %}
                                {% if session.session_lists %}
                                    {{ session.session_lists[0].list.name }}
                                {% else %}
                                    Enkele Quiz
                                {% endif %}
                            {% else %}
                                Gemengde Quiz
                                {% if session.session_lists %}
                                    ({{ session.session_lists|length }} lijsten)
                                {% endif %}
                            {% endif %}
                        </h4>
                        <p class="session-date">Gestart op {{ session.started_at.strftime('%d %b %Y, %H:%M') }}</p>
                    </div>
                    <div class="session-progress">
                        <span class="progress-text">{{ session.current_index }}/{{ session.total_questions }}</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ (session.current_index / session.total_questions * 100) if session.total_questions > 0 else 0 }}%"></div>
                        </div>
                    </div>
                </div>
                <div class="session-meta">
                    <span class="badge">{{ session.direction|upper }}</span>
                    {% if session.quiz_type == 'mixed' and session.session_lists %}
                        <span class="list-names">
                            {% for sl in session.session_lists[:3] %}
                                {{ sl.list.name }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                            {% if session.session_lists|length > 3 %}
                                +{{ session.session_lists|length - 3 }} meer
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
                <div class="session-actions">
                    <a href="{{ url_for('main.resume_quiz', session_id=session.id) }}" class="btn btn-small btn-primary">
                        <i class="fas fa-play"></i> Hervat Quiz
                    </a>
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}

{% if sessions %}
    <div class="quiz-history-stats">
        <div class="stat-card">
            <h3>{{ sessions|length }}</h3>
            <p>Quizzen voltooid</p>
        </div>
        <div class="stat-card">
            <h3>{{ "%.1f"|format((sessions|map(attribute='score_percentage')|sum / sessions|length) if sessions else 0) }}%</h3>
            <p>Gemiddelde score</p>
        </div>
    </div>

    {% if sessions|length > 3 %}
    <div class="score-trend">
        <h3>Score Verloop</h3>
        <canvas id="scoreTrendChart" width="400" height="150"></canvas>
    </div>
    {% endif %}

    <div class="quiz-sessions-list">
        <h3>Alle Quizzen</h3>
        {% for session in sessions %}
            <div class="session-card">
                <div class="session-header">
                    <div>
                        <h4>
                            {% if session.quiz_type == 'single' %}
                                {% if session.session_lists %}
                                    {{ session.session_lists[0].list.name }}
                                {% else %}
                                    Enkele Quiz
                                {% endif %}
                            {% else %}
                                Gemengde Quiz
                                {% if session.session_lists %}
                                    ({{ session.session_lists|length }} lijsten)
                                {% endif %}
                            {% endif %}
                        </h4>
                        <p class="session-date">{{ session.completed_at.strftime('%d %b %Y, %H:%M') }}</p>
                    </div>
                    <div class="session-score {% if session.score_percentage >= 80 %}score-excellent{% elif session.score_percentage >= 60 %}score-good{% else %}score-needs-work{% endif %}">
                        <span class="score-number">{{ session.correct_answers }}/{{ session.total_questions }}</span>
                        <span class="score-percentage">{{ session.score_percentage }}%</span>
                    </div>
                </div>
                <div class="session-meta">
                    <span class="badge">{{ session.direction|upper }}</span>
                    {% if session.quiz_type == 'mixed' and session.session_lists %}
                        <span class="list-names">
                            {% for sl in session.session_lists[:3] %}
                                {{ sl.list.name }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                            {% if session.session_lists|length > 3 %}
                                +{{ session.session_lists|length - 3 }} meer
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
                <div class="session-actions">
                    <a href="{{ url_for('main.quiz_history_detail', session_id=session.id) }}" class="btn btn-small btn-primary">
                        <i class="fas fa-eye"></i> Bekijk Details
                    </a>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <p class="empty-state">Je hebt nog geen quizzen voltooid. <a href="{{ url_for('main.index') }}">Start een quiz!</a></p>
{% endif %}

{% if sessions|length > 3 %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
const ctx = document.getElementById('scoreTrendChart').getContext('2d');
const sessions = {{ sessions|tojson }};

// Reverse to show oldest first in chart
const reversedSessions = sessions.slice().reverse();

const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: reversedSessions.map((s, i) => i + 1),
        datasets: [{
            label: 'Score %',
            data: reversedSessions.map(s => s.score_percentage),
            borderColor: '#4CAF50',
            backgroundColor: 'rgba(76, 175, 80, 0.1)',
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Quiz Nummer'
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.parsed.y.toFixed(1) + '%';
                    }
                }
            }
        }
    }
});
</script>
{% endif %}

<style>
.incomplete-quizzes {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    padding: 2rem;
    border-radius: 8px;
    margin-bottom: 2rem;
}

.incomplete-quizzes h3 {
    color: white;
    margin-top: 0;
}

.incomplete-notice {
    color: white;
    margin-bottom: 1.5rem;
}

.session-card.incomplete {
    background: white;
    margin-bottom: 1rem;
    border-left-color: #f5576c;
}

.session-progress {
    text-align: right;
}

.progress-text {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.progress-bar {
    width: 120px;
    height: 8px;
    background: var(--border-color);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
    transition: width 0.3s;
}

.quiz-history-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: var(--card-background);
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
}

.stat-card h3 {
    font-size: 2.5rem;
    margin: 0 0 0.5rem 0;
    color: var(--primary-color);
}

.stat-card p {
    margin: 0;
    color: var(--text-secondary);
}

.score-trend {
    background: var(--card-background);
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
}

.score-trend h3 {
    margin-top: 0;
}

.quiz-sessions-list h3 {
    margin-bottom: 1rem;
}

.session-card {
    background: var(--card-background);
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    border-left: 4px solid var(--border-color);
}

.session-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.session-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.session-header h4 {
    margin: 0 0 0.25rem 0;
}

.session-date {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin: 0;
}

.session-score {
    text-align: right;
}

.score-number {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
}

.score-percentage {
    display: block;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.score-excellent .score-number { color: #4CAF50; }
.score-good .score-number { color: #FF9800; }
.score-needs-work .score-number { color: #F44336; }

.session-meta {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1rem;
}

.badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: var(--primary-color);
    color: white;
    border-radius: 4px;
    font-size: 0.85rem;
    text-transform: uppercase;
}

.list-names {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.session-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-small {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}
</style>
{% endblock %}
